<framework>

<execution>
    <!--clock sleep="true" unit="ms" value="100"/-->
</execution>
<logging>
    <filter tagPrefix="LOCAL_COURSE_SERVICE" logLevel="ERROR"/>
</logging>
    <modulesToEnable>
        <module logLevel="WARN">pause_runtime</module>
        <module logLevel="WARN">image_hint_generator</module>
        <module logLevel="ERROR">image_hint_transformer</module>
        <module logLevel="WARN">image_hint_transformer_obstacle</module>
        <module logLevel="WARN">lap_time</module>
        <module logLevel="ERROR">image_hint_worker_lane</module>
        <module logLevel="ERROR">image_hint_worker_obstacle</module>
        <module logLevel="WARN">environment_predictor</module>
        <module logLevel="WARN">trajectory_creator</module>
        <module logLevel="ERROR">street_obstacle_ir_detector</module>
        <module logLevel="WARN">trajectory_point_controller</module>
        <module logLevel="WARN">image_proxy</module>
        <module logLevel="WARN">street_obstacle_merger</module>
        <module logLevel="INFO">sobel_threshold_generator</module>
        <module logLevel="WARN">obstacle_to_local_course</module>
        <module logLevel="ERROR">course_state_estimator</module>
        <!--module logLevel="DEBUG">car_to_matlab</module-->
        <if set="sendData">
            <module logLevel="INFO">socket_data_sender</module>
            <module logLevel="WARN">image_converter_scaledown</module>
        </if>
    </modulesToEnable>
    <service>
        <name>PHOENIX_SERVICE</name>
        <realName>phoenix_CC2016_service</realName>
            <config>
                <stateFromConfig>true</stateFromConfig>
                <updateInMilliS>-1</updateInMilliS>
            </config>
    </service>
    <service>
        <name>LOCAL_COURSE_SERVICE</name>
        <realName>local_course</realName>
        <config>
            <useThresholding>true</useThresholding>
            <thresholdLutX>0.0, 0.5, 1.5</thresholdLutX>
            <thresholdLutY>0.1, 0.1, 0.1</thresholdLutY>
            <thresholdingSlope>0.08</thresholdingSlope>
            <outlierStartingPoint>2</outlierStartingPoint>
            <outlierPercentile>0.5</outlierPercentile>
            <outlierPercentileMultiplier>3.0</outlierPercentileMultiplier>
            <elementCount>10</elementCount>
            <kovAbnahme>0.15</kovAbnahme>
            <elementLength>0.2</elementLength>
            <logState>false</logState>
            <idle_prior_fact>10</idle_prior_fact>
            <prior_fact>0</prior_fact>
        </config>
    </service>
    <module>
        <name>lap_time</name>
        <channelMapping from="ENVIRONMENT" to="ENVIRONMENT_OBSTACLE"/>
    </module>
    <module>
        <name>pause_runtime</name>
    </module>
    <module>
        <name>sobel_threshold_generator</name>
        <channelMapping from="IMAGE" to="GREY_IMAGE"/>
    </module>
    
    <module>
        <name>street_obstacle_ir_detector</name>
        <config>
            <obstacleMinDistance>0.10</obstacleMinDistance>
            <obstacleInitTrust>0.5</obstacleInitTrust>
            <obstacleTriggerDistance>0.30</obstacleTriggerDistance>
            <obstacleWidth>0.1</obstacleWidth>
        </config>
        <channelMapping from="ENVIRONMENT" to="ENVIRONMENT_OBSTACLE_RAW"/>
    </module>
    <module>
        <name>street_obstacle_merger</name>
        <channelMapping priority="10" from="CAR" to="CAR"/>
        <channelMapping from="ENVIRONMENT_INPUT" to="ENVIRONMENT_OBSTACLE_RAW"/>
        <channelMapping from="ENVIRONMENT_OUTPUT" to="ENVIRONMENT_OBSTACLE"/>
        <config src="street_utils/obstacle.lconf"/>
    </module>
    <module>
        <name>car_to_matlab</name>
    </module>
    <module>
        <name>image_converter_scaledown</name>
        <realName>image_converter</realName>
        <channelMapping from="INPUT_IMAGE" to="GREY_IMAGE"/>
        <channelMapping from="OUTPUT_IMAGE" to="IMAGE_GREY_SCALE"/>
        <config>
            <scaleDown>4</scaleDown>
        </config>
    </module>
    <module>
        <name>socket_data_sender</name>
        <config>
            <ip>localhost</ip>
            <port>65001</port>
        </config>
    </module>
    <module>
        <name>trajectory_point_controller</name>
        <channelMapping from="TRAJECTORY" to="TRAJECTORY_LINE"/>
        <config>
            <!--MPC-controller-->
            <mpcLookupVelocityX>1.0, 2.5, 6.0</mpcLookupVelocityX>
            <mpcLookupVelocityY>1.0, 2.5, 5.0</mpcLookupVelocityY>
            <regelpunktMin>0.4</regelpunktMin>
            <regelpunktSlope>0.1</regelpunktSlope>
            <distanceRegelpunkt>0.9</distanceRegelpunkt>
            <yawRateBoost>0.0</yawRateBoost>
            <useMPCcontroller>1</useMPCcontroller> 
            <weight_y>20</weight_y>
            <weight_phi>5</weight_phi>
            <weight_steering_front>0.0001</weight_steering_front>
            <weight_steering_rear>8</weight_steering_rear>
            <maxParallelAusweichen>0.2</maxParallelAusweichen>
            <!--velocity-controller -->
            <!-- trajecotryPoint-->
            <trajectoryPointDistanceLookupX>1.8,3.0</trajectoryPointDistanceLookupX>
            <trajectoryPointDistanceLookupY>0.6,0.6</trajectoryPointDistanceLookupY>

            <!--default velo-->
            <forcastLength>1</forcastLength>
            <minForcastLength>0.4</minForcastLength>
            <maxForcastLength>1.4</maxForcastLength>
            <targetForcastLength>1.0</targetForcastLength>
            <weightSlope>2</weightSlope>
            <weightOffset>3</weightOffset>

            <!--stop at crossing -->
            <!-- stop on crossing-->
            <PID_Kp>2</PID_Kp>
            <PID_Ki>0</PID_Ki>
            <PID_Kd>0</PID_Kd>
            <crossingSaftyZone>0.05</crossingSaftyZone>
            <maxVelocityCrossing>2.0</maxVelocityCrossing>
            <distanceToStop>2.0</distanceToStop>
            <stoppingDistance>0.35</stoppingDistance>

        </config>
    </module>
    <module>
        <name>image_hint_generator</name>
        <channelMapping priority="10" from="HINTS" to="HINTS"/>
        <channelMapping priority="10" from="HINTS_OBSTACLE" to="HINTS_OBSTACLE"/>
        <channelMapping from="TARGET_IMAGE" to="GREY_IMAGE"/>
        <channelMapping priority="10" from="MIDDLE_LANE" to="MIDDLE_LANE"/>
        <config>
            <searchForObstacles>true</searchForObstacles>
            <searchForCrossing>true</searchForCrossing>
            <numerOfSegmentsLines>1</numerOfSegmentsLines>
            <maxSearchLength>4.0</maxSearchLength>
            <lineOffset>0.1</lineOffset>
        </config>
        <config name="defaultEPParameter" src="imaging/defaultEdgePointParam.lconf"/>
        <config name="defaultLPParameter" src="imaging/defaultLinePointParam.lconf"/>
        <config name="defaultLineParameter" src="imaging/defaultLineParam.lconf"/>
        <config name="defaultObstacleParameter" src="imaging/defaultObstacleParam.lconf"/>
        <config name="defaultCrossingParameter" src="imaging/defaultCrossingParam.lconf"/>
    </module>
    <module>
        <name>sensor_tracker</name><!--Brauchen wir den noch?-->
    </module>
    <module>
        <name>trajectory_creator</name>
        <channelMapping from="LINE" to="TRAJECTORY_LINE"/>
        <channelMapping from="ROAD" to="MIDDLE_LANE"/>
        <channelMapping from="ENVIRONMENT_OBSTACLE" to="ENVIRONMENT_OBSTACLE"/>
        <channelMapping priority="9" from="CAR" to="CAR"/>
        <config name="FMH">
            <velocity_straight>3.5</velocity_straight>
            <curve_maxVelocity>3.0</curve_maxVelocity>
            <curve_minVelocity>2.0</curve_minVelocity>
            <curveStraight_maxVelocity>3.0</curveStraight_maxVelocity>
            <curveStraight_minVelocity>2.0</curveStraight_minVelocity>
            <aOrthMax>2.5</aOrthMax>
            <simpleTraj>true</simpleTraj>
            <angleD>0.35</angleD>
            <obstacleResolution>0.05</obstacleResolution>
            <minDistanceBetweenTrajectoryPoints>0.2</minDistanceBetweenTrajectoryPoints>
            <distanceObstacleBeforeChangeLine>1</distanceObstacleBeforeChangeLine>
            <obstacleLength>0.7</obstacleLength>
        </config>
        <config name="FOH">
            <velocity_straight>5.0</velocity_straight>
            <curve_maxVelocity>2.8</curve_maxVelocity>
            <curve_minVelocity>2.4</curve_minVelocity>
            <curveStraight_maxVelocity>4.0</curveStraight_maxVelocity>
            <curveStraight_minVelocity>2.8</curveStraight_minVelocity>
            <aOrthMax>3.5</aOrthMax>
            <simpleTraj>true</simpleTraj>
            <angleD>0.35</angleD>
            <obstacleResolution>0.05</obstacleResolution>
            <minDistanceBetweenTrajectoryPoints>0.2</minDistanceBetweenTrajectoryPoints>
            <distanceObstacleBeforeChangeLine>1</distanceObstacleBeforeChangeLine>
            <obstacleLength>0.7</obstacleLength>
        </config>
        <config>
          <obstacleResolution>0.05</obstacleResolution>
          <minDistanceBetweenTrajectoryPoints>0.2</minDistanceBetweenTrajectoryPoints>
          <obstacleSavetyDistance>1.0</obstacleSavetyDistance>
          <simpleTraj>true</simpleTraj>
        </config>
        <config src="street_utils/obstacle.lconf"/>
        <config src="trajectory_creator.lconf"/>
    </module>
    <module>
        <name>obstacle_to_local_course</name>
        <channelMapping from="ENVIRONMENT" to="ENVIRONMENT_OBSTACLE"/>
        <config>
            <obstacleMinTrust>0.8</obstacleMinTrust>
            <virtualCrossingPoints>2</virtualCrossingPoints>
        </config>
    </module>
    <module>
        <name>environment_filter</name>
        <channelMapping from="ENVIRONMENT_ItoGoXNPUT" to="ENVIRONMENT_ROAD_RAW"/>
        <channelMapping from="ENVIRONMENT_OUTPUT" to="ENVIRONMENT_ROAD_FILTERED"/>
    </module>
    <module>
        <name>environment_predictor</name>
        <channelMapping priority="10" from="CAR" to="CAR"/>
        <channelMapping from="ENVIRONMENT_INPUT" to="ENVIRONMENT_ROAD_RAW"/>
        <channelMapping from="ROAD_OUTPUT" to="MIDDLE_LANE"/>
        <config user="odroid">
            <logPrefix>/home/odroid/data/env/env</logPrefix>
            <r_fakt_min>15</r_fakt_min>
            <r_fakt_max>50</r_fakt_max>
            <r_fakt_maxVelocity>5.0</r_fakt_maxVelocity>
        </config>
        <config>
            <translateEnvironment>false</translateEnvironment>
        </config>
    </module>
    <module>
        <name>image_hint_transformer</name>
        <channelMapping from="ENVIRONMENT" to="ENVIRONMENT_ROAD_RAW"/>
    </module>
    <module>
        <name>image_hint_transformer_obstacle</name>
        <realName>image_hint_transformer</realName>
        <channelMapping priority="1" from="ENVIRONMENT" to="ENVIRONMENT_OBSTACLE_RAW"/>
        <channelMapping from="HINTS" to="HINTS_OBSTACLE"/>

    </module>
    <module>
        <name>image_hint_worker_lane</name>
        <realName>image_hint_worker</realName>
        <channelMapping priority="2" from="HINTS" to="HINTS"/>
    </module>
    <module>
        <name>image_hint_worker_obstacle</name>
        <realName>image_hint_worker</realName>
        <channelMapping priority="2"  from="HINTS" to="HINTS_OBSTACLE"/>
        <channelMapping from="DEBUG_IMAGE" to="DEBUG_IMAGE_OBSTACLE"/>
    </module>
    <module>
        <name>image_proxy</name>
        <channelMapping from="INPUT_IMAGE" to="GREY_IMAGE_PRE" />
        <channelMapping from="OUTPUT_IMAGE" to="GREY_IMAGE"/>
        <config><!--IMAGE_CHANNEL-->
            <displayMode>IMAGE_CHANNEL</displayMode>
        </config>
        <config user="phibedy">
            <directory>/home/phibedy/Dokumente/programmieren/c++/lms_repos/config_auto_drive/test_images/20150625-151241</directory>
            <singleFile>/home/phibedy/Dokumente/programmieren/c++/lms_repos/config_auto_drive/test_images/20150519-164907/0000.pgm</singleFile>
        </config>
        <config user="hans">
            <directory>/home/hans/phoenix/config_auto_drive/test_images/20150519-164907</directory>
            <singleFile>/home/hans/phoenix/config_auto_drive/test_images/20150519-164907/0050.pgm</singleFile>
        </config>
        <config user="tobi">
            <directory>/home/tobi/phoenix_code/repos/config_auto_drive/test_images/20150519-164907</directory>
            <singleFile>/home/tobi/phoenix_code/repos/config_auto_drive/test_images/20150512-181426/0050.pgm</singleFile>
        </config>
        <config user="jochen">
            <directory>/data/projects/tum.phoenix/code/config_auto_drive/test_images/20150519-164907</directory>
            <singleFile>/data/projects/tum.phoenix/code/config_auto_drive/test_images/20150512-181426/0050.pgm</singleFile>
        </config>
    </module>
    <module>
        <name>course_state_estimator</name>
        <channelMapping from="ROAD" to="MIDDLE_LANE"/>
        <channelMapping from="ENVIRONMENT" to="ENVIRONMENT_ROAD_RAW"/>
        <config>
        <observationProbability1>0.6</observationProbability1>
            <observationProbability2>0.7</observationProbability2>
            <distance1>0.4</distance1>
            <distance2>0.8</distance2>
            <distance3>0.8</distance3>
            <distance4>1.4</distance4>
            <curvatureThreshold>0.2</curvatureThreshold>
            <transitionProbabilityStraightToStraightCurve>0.002</transitionProbabilityStraightToStraightCurve>
            <transitionProbabilityStraightCurveToCurve>0.002</transitionProbabilityStraightCurveToCurve>
            <transitionProbabilityCurveToStraight>0.001</transitionProbabilityCurveToStraight>
            <useKalmanCurvature>true</useKalmanCurvature>
            <useProbabilitiesStraight>true</useProbabilitiesStraight>
         </config>
    </module>
    <include src="ego.xml"/>
</framework>
